<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Study Scheduler</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body class="bg-light">
  <h1 class="bg-secondary text-center fluid py-4">ðŸ“… Study Smarter</h1>
  <div class="container pb-4">

    <!-- Google Sign In -->
    <div class="card mb-4">
      <div class="card-body text-center">
        <button id="authorize_button" class="btn btn-primary">Sign in with Google</button>
        <button id="signout_button" class="btn btn-outline-danger d-none">Sign Out</button>
      </div>
    </div>

    <!-- Task Input -->
    <div class="card mb-4">
      <div class="card-header">Add a Study Task</div>
      <div class="card-body">
        <form id="taskForm" class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Task Name</label>
            <input type="text" class="form-control" id="taskName" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Due Date</label>
            <input type="date" class="form-control" id="taskDue" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Estimated Study Hours</label>
            <input type="number" class="form-control" id="taskHours" min="1" required>
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-success">Add Task</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Task List -->
    <div class="card mb-4">
      <div class="card-header">Tasks</div>
      <ul class="list-group list-group-flush" id="taskList"></ul>
    </div>

    <!-- Schedule Output -->
    <div class="card">
      <div class="card-header">Suggested Study Schedule</div>
      <ul class="list-group list-group-flush" id="scheduleList"></ul>
    </div>
  </div>

  <script>
    const CLIENT_ID = "http://1061855570713-evtnvbajus4st7fbhr90go06oa2ceong.apps.googleusercontent.com"; // replace with your client ID
    const API_KEY = "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"; // replace with your API key
    const SCOPES = "https://www.googleapis.com/auth/calendar";

    let gapiInited = false;
    let gisInited = false;
    let tokenClient;
    let tasks = [];

    const authorizeButton = document.getElementById("authorize_button");
    const signoutButton = document.getElementById("signout_button");
    const taskForm = document.getElementById("taskForm");
    const taskList = document.getElementById("taskList");
    const scheduleList = document.getElementById("scheduleList");

    function gapiLoaded() {
      gapi.load("client", initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
      });
      gapiInited = true;
    }

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: "", // defined later
      });
      gisInited = true;
    }

    authorizeButton.onclick = () => {
      tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) throw (resp);
        authorizeButton.classList.add("d-none");
        signoutButton.classList.remove("d-none");
        await listFreeBusy();
      };
      if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({ prompt: "consent" });
      } else {
        tokenClient.requestAccessToken({ prompt: "" });
      }
    };

    signoutButton.onclick = () => {
      const token = gapi.client.getToken();
      if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken("");
        authorizeButton.classList.remove("d-none");
        signoutButton.classList.add("d-none");
      }
    };

    taskForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const name = document.getElementById("taskName").value;
      const due = document.getElementById("taskDue").value;
      const hours = parseInt(document.getElementById("taskHours").value);
      tasks.push({ name, due, hours });
      renderTasks();
      taskForm.reset();
      scheduleTasks();
    });

    function renderTasks() {
      taskList.innerHTML = "";
      tasks.forEach((t, i) => {
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.textContent = `${t.name} (Due: ${t.due}, Hours: ${t.hours})`;
        const btn = document.createElement("button");
        btn.className = "btn btn-sm btn-danger";
        btn.textContent = "Remove";
        btn.onclick = () => {
          tasks.splice(i, 1);
          renderTasks();
          scheduleTasks();
        };
        li.appendChild(btn);
        taskList.appendChild(li);
      });
    }

    async function listFreeBusy() {
      const now = new Date();
      const weekLater = new Date();
      weekLater.setDate(now.getDate() + 7);

      const response = await gapi.client.calendar.freebusy.query({
        resource: {
          timeMin: now.toISOString(),
          timeMax: weekLater.toISOString(),
          timeZone: "UTC",
          items: [{ id: "primary" }],
        },
      });

      const busy = response.result.calendars.primary.busy;
      const freeSlots = [];
      let last = now;
      busy.forEach((b) => {
        const start = new Date(b.start);
        if (last < start) {
          freeSlots.push({ start: last, end: start });
        }
        last = new Date(b.end);
      });
      if (last < weekLater) freeSlots.push({ start: last, end: weekLater });

      return freeSlots;
    }

    async function scheduleTasks() {
      scheduleList.innerHTML = "<li class='list-group-item'>Finding free time...</li>";
      const freeSlots = await listFreeBusy();
      scheduleList.innerHTML = "";
      let scheduled = [];

      for (const task of tasks) {
        let remaining = task.hours;
        for (const slot of freeSlots) {
          if (remaining <= 0) break;
          let slotHours = (slot.end - slot.start) / (1000 * 60 * 60);
          if (slotHours > 0) {
            let used = Math.min(remaining, slotHours);
            scheduled.push({
              task: task.name,
              start: new Date(slot.start),
              end: new Date(slot.start.getTime() + used * 60 * 60 * 1000),
            });
            slot.start = new Date(slot.start.getTime() + used * 60 * 60 * 1000);
            remaining -= used;
          }
        }
      }

      if (scheduled.length === 0) {
        scheduleList.innerHTML = "<li class='list-group-item text-danger'>No free slots available</li>";
      } else {
        scheduled.forEach((s) => {
          const li = document.createElement("li");
          li.className = "list-group-item";
          li.textContent = `${s.task}: ${s.start.toLocaleString()} â†’ ${s.end.toLocaleString()}`;
          scheduleList.appendChild(li);
        });
      }
    }

    window.gapiLoaded = gapiLoaded;
    window.gisLoaded = gisLoaded;
  </script>
</body>
</html>
